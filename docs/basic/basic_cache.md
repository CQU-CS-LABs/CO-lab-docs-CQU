# 基础Cache

## 类 sram 接口

在实现基础 cache 时，cache 与数据通路和转接桥之间都通过类 sram 接口进行通信，所以我们需要足够了解类 sram 接口的工作方式  
类 sram 接口包括以下信号:  

| 信号      | 位宽     | 方向            | 功能                                    |
| ------- | ------ | ------------- | ------------------------------------- |
| clk     | 1      | master->slave | 时钟信号                                  |
| req     | 1      | master->slave | 请求信号，置1时表示有读写请求                       |
| wr      | 1      | master->slave | 写使能信号，置1时表示该次请求为写                     |
| size    | [1:0]  | master->slave | 该次请求传输的字节数，0：1byte，1：2bytes， 2：4bytes |
| addr    | [31:0] | master->slave | 该次请求的地址                               |
| wdata   | [31:0] | master->slave | 该次请求写的数据                              |
| addr_ok | 1      | slave->master | 表示该次请求的地址传输 OK，读：地址传输完成，写：地址和数据均传输完成  |
| data_ok | 1      | slave->master | 该次请求的数据 OK，读：希望读的数据返回，写：数据写入完成        |
| rdata   | [31:0] | slave->master | 该次请求返回的数据                             |

类 sram 接口一次请求的大致过程如下：

* master 端拉高 `req` 信号并给出该次请求的各项参数（读或写，请求的地址，请求的字节数，请求写的数据等等）

* slave 端存储 master 端给出的请求参数后拉高 `addr_ok` （在 `addr_ok` 拉高后 master 可能不再保持请求各项参数有效）

* slave 处理请求，这可能需要数个周期（存储器的时钟速度往往慢于 CPU 故读写，可能需要多个周期完成读写）

* slave 处理完成，将请求处理结果返回，并拉高 `data_ok` （读：需要在 `rdata` 上给出读取的数据，写：仅拉高 `data_ok` 即可）

注意 sram 接口的地址信号（addr）以字节寻址，其指向读写数据的最低有效位。我们需要将 addr 和 size 信号配合起来使用：  

* `size`==0 读写单字节，`addr` 最低两位可以是任意值

* `size`==1 读写半字，`addr` 最低位需要为 0，否则发生地址错误异常

* `size`==2 读写一个字，`addr` 最低两位需要为 0，否则发生地址错误异常

下表列出了在各种有效的 addr 和 size 组合下，有效数据出现的位置

|                                    | `data[31:24]` | `data[23:16]` | `data[15:8]` | `data[7:0]` |
| ---------------------------------- | ------------- | ------------- | ------------ | ----------- |
| `size`==2'b00, `addr[1:0]`==2'b00  | -             | -             | -            | valid       |
| `size`==2'b00, `addr[1:0]`==2'b01  | -             | -             | valid        | -           |
| `size`==2'b00, `addr[1:0]`==2'b10  | -             | valid         | -            | -           |
| `size`==2'b00, `addr[1:0]`==2'b11  | valid         | -             | -            | -           |
| `size`==2'b01, `addr[1:0]`==2'b00  | -             | -             | valid        | valid       |
| `size`==2'b01,  `addr[1:0]`==2'b10 | valid         | valid         | -            | -           |
| `size`==2'b10, `addr[1:0]`==2'b00  | valid         | valid         | valid        | valid       |

## 类 sram 接口的状态机设计

在了解了类 sram 接口的工作机制之后，我们可以基于此设计一个状态机来控制类 sram 接口的数据传输，设计状态机需要关注状态机可能处于的状态和促使状态改变的标志信号或者标志信号组合   
我们首先来看看类 sram 接口可能处于的状态：  

* `IDLE`：等待请求到达

* `ADDR`：传输包括 addr 在内的请求参数

* `DATA`：传输数据

以上给出的状态是一个比较简单但是可行的例子，我们也可以添加更多状态以实现对类 sram 接口更加精细的控制

## 写回 cache



## 多路 cache

## Cache 的状态机设计